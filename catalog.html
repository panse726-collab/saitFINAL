<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="–î–ê–ù–ò–ò–õ –†–û–ú–ê–ù–û–í–ò–ß ‚Äî —é–≤–µ–ª–∏—Ä–Ω—ã–π –∫–æ–Ω—Å—å–µ—Ä–∂ –∏–∑ –ö–∏—Ç–∞—è. –ü—Ä–µ–º–∏—É–º-–∫–∞–º–Ω–∏ –∏ –∏–∑–¥–µ–ª–∏—è –ø–æ–¥ –∫–ª—é—á. –ü—Ä–æ–∑—Ä–∞—á–Ω–æ. –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ. –ü–æ –¥–æ–≥–æ–≤–æ—Ä—É.">
    <meta name="color-scheme" content="dark only">
    <meta name="theme-color" content="#0B0B0F">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="supported-color-schemes" content="dark">
    <title>–î–ê–ù–ò–ò–õ –†–û–ú–ê–ù–û–í–ò–ß ‚Äî –Æ–≤–µ–ª–∏—Ä–Ω—ã–π –∫–æ–Ω—Å—å–µ—Ä–∂</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <header>
        <div class="container">
            <div class="header-left">
                <a href="index.php" class="logo header-brand-link" aria-label="Daniil Romanovich">Daniil Romanovich</a>
            </div>

            <nav class="header-nav" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
                <a href="index.php" class="header-nav__link" data-page="home">–ì–ª–∞–≤–Ω–∞—è</a>
                <a href="catalog.html" class="header-nav__link is-active" data-page="catalog">–ö–∞—Ç–∞–ª–æ–≥</a>
                <a href="bags.html" class="header-nav__link" data-page="bags">–°—É–º–∫–∏</a>
                <a href="watches.html" class="header-nav__link" data-page="watches">–ß–∞—Å—ã</a>
                <a href="index.php#channels" class="header-nav__link" data-page="channels">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
            </nav>

            <div class="header-right">
                <button class="header-menu-btn" type="button" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é" aria-expanded="false" data-mobile-nav-toggle>
                    <span></span><span></span><span></span>
                </button>
            </div>
        </div>

        <div class="header-mobile-nav" data-mobile-nav aria-hidden="true">
            <div class="header-mobile-panel" role="navigation" aria-label="–ú–µ–Ω—é">
                <button class="header-mobile-close" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é" data-mobile-nav-close>
                    <span aria-hidden="true">√ó</span>
                </button>
                <a href="index.php" data-page="home">–ì–ª–∞–≤–Ω–∞—è</a>
                <a href="catalog.html" data-page="catalog" class="is-active">–ö–∞—Ç–∞–ª–æ–≥</a>
                <a href="bags.html" data-page="bags">–°—É–º–∫–∏</a>
                <a href="watches.html" data-page="watches">–ß–∞—Å—ã</a>
                <a href="index.php#channels" data-page="channels">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
            </div>
        </div>
    </header>

    <section class="services" id="page-catalog" style="padding-top: 120px;">
        <div class="container">
            <div class="page-top-row">
                <a href="index.php" class="back-to-main">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 5.5a1 1 0 0 1 0 1.4L10.4 12l5.1 5.1a1 1 0 1 1-1.4 1.4l-5.8-5.8a1 1 0 0 1 0-1.4l5.8-5.8a1 1 0 0 1 1.4 0Z"/></svg>
                    –ù–∞ –≥–ª–∞–≤–Ω—É—é
                </a>
                <div class="hero-eyebrow">–ö–∞—Ç–∞–ª–æ–≥</div>
            </div>
            <h1 class="hero-title-gold">
                <span class="catalog-title-line">–í–∏—Ç—Ä–∏–Ω–∞ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞</span>
                <span class="catalog-title-line">–£–¥–æ–±–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–º –º–æ–¥–µ–ª—è–º</span>
            </h1>
            <p class="hero-description">
                –≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª ‚Äî –≤–∏—Ç—Ä–∏–Ω–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–∞ –∏ –ø–æ–¥–±–æ—Ä–∞
            </p>
            <div class="hero-buttons">
                <a href="https://t.me/+dY4peRlG7-I4ZWQ8" target="_blank" class="btn btn-outline-gold btn-outline-pill btn-telegram-cta">
                    <span class="btn-text">–û—Ç–∫—Ä—ã—Ç—å –ø–æ–ª–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥</span>
                    <span class="btn-badge">TELEGRAM</span>
                </a>
            </div>

            <div class="catalog-controls">
                <div class="catalog-controls-top">
                    <div class="catalog-search">
                        <svg class="catalog-search__icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <path d="M10 2a8 8 0 1 0 4.9 14.32l4.39 4.39a1 1 0 0 0 1.42-1.42l-4.39-4.39A8 8 0 0 0 10 2zm0 2a6 6 0 1 1 0 12a6 6 0 0 1 0-12z"/>
                        </svg>
                        <input type="text" class="catalog-search__input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é..." data-catalog-search>
                    </div>
                </div>

                <div class="catalog-cats" role="tablist" aria-label="–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–∞—Ç–∞–ª–æ–≥–∞">
                    <button class="catalog-cat is-active" type="button" data-catalog-cat="all" role="tab" aria-selected="true">–í—Å–µ</button>
                    <button class="catalog-cat" type="button" data-catalog-cat="jewelry" role="tab" aria-selected="false">–Æ–≤–µ–ª–∏—Ä–Ω—ã–µ –∏–∑–¥–µ–ª–∏—è</button>
                    <button class="catalog-cat" type="button" data-catalog-cat="bags" role="tab" aria-selected="false">–°—É–º–∫–∏</button>
                    <button class="catalog-cat" type="button" data-catalog-cat="watches" role="tab" aria-selected="false">–ß–∞—Å—ã</button>
                    <button class="catalog-cat" type="button" data-catalog-cat="accessories" role="tab" aria-selected="false">–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</button>
                </div>
            </div>

            <div class="catalog-grid catalog-grid--single" data-catalog-grid></div>

            <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div class="catalog-loading" data-catalog-loading>
                <div class="catalog-loading__spinner"></div>
                <div class="catalog-loading__text">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë" -->
            <div class="catalog-load-more" data-catalog-load-more hidden>
                <button class="catalog-load-more__btn" type="button" data-load-more-btn>
                    <span>–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë</span>
                    <span class="catalog-load-more__count" data-load-more-count></span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>
            </div>

            <div class="catalog-empty" data-catalog-empty hidden>
                <svg class="catalog-empty__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="M21 21l-4.35-4.35"></path>
                    <path d="M8 11h6"></path>
                </svg>
                <div class="catalog-empty__title">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                <div class="catalog-empty__text">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é</div>
            </div>
        </div>
    </section>

    <!-- PRODUCT DETAIL OVERLAY -->
    <section class="page-overlay page-overlay--product" id="page-product" aria-hidden="true">
        <div class="page-overlay__backdrop" data-close-product></div>
        <div class="page-overlay__scroll">
            <div class="product-sheet" role="dialog" aria-modal="true" aria-label="–ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞">
                <div class="product-sheet__header">
                    <button class="product-sheet__backbtn" type="button" data-close-product aria-label="–ù–∞–∑–∞–¥ –≤ –∫–∞—Ç–∞–ª–æ–≥">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 5.5a1 1 0 0 1 0 1.4L10.4 12l5.1 5.1a1 1 0 1 1-1.4 1.4l-5.8-5.8a1 1 0 0 1 0-1.4l5.8-5.8a1 1 0 0 1 1.4 0Z"/></svg>
                        <span>–ù–∞–∑–∞–¥</span>
                    </button>
                    <div class="product-sheet__title" id="productTitleBar">–¢–æ–≤–∞—Ä</div>
                </div>
                <div class="product-sheet__body">
                    <div class="container">
                        <div class="glass-card product-modal">
                            <div class="product-modal__closeWrap">
                                <button class="product-modal__close" id="productCloseBtn" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É —Ç–æ–≤–∞—Ä–∞">
                                    <span aria-hidden="true">√ó</span>
                                </button>
                            </div>
                            <div class="product-layout">
                                <div class="product-carousel" aria-label="–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ç–æ–≤–∞—Ä–∞">
                                    <div class="product-carousel__main">
                                        <img src="" alt="" id="productMainImage">
                                    </div>
                                    <div class="product-carousel__nav" aria-hidden="false">
                                        <button class="product-carousel__btn" type="button" data-carousel-prev aria-label="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Ñ–æ—Ç–æ">
                                            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M15.5 5.5a1 1 0 0 1 0 1.4L10.4 12l5.1 5.1a1 1 0 1 1-1.4 1.4l-5.8-5.8a1 1 0 0 1 0-1.4l5.8-5.8a1 1 0 0 1 1.4 0Z"/></svg>
                                        </button>
                                        <button class="product-carousel__btn" type="button" data-carousel-next aria-label="–°–ª–µ–¥—É—é—â–µ–µ —Ñ–æ—Ç–æ">
                                            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M8.5 18.5a1 1 0 0 1 0-1.4l5.1-5.1-5.1-5.1a1 1 0 1 1 1.4-1.4l5.8 5.8a1 1 0 0 1 0 1.4l-5.8 5.8a1 1 0 0 1-1.4 0Z"/></svg>
                                        </button>
                                    </div>
                                    <div class="product-carousel__thumbs" id="productThumbs" aria-label="–ú–∏–Ω–∏–∞—Ç—é—Ä—ã"></div>
                                </div>

                                <div class="product-info">
                                    <span class="catalog-pill" id="productCategory">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</span>
                                    <h2 class="product-title" id="productTitle">–¢–æ–≤–∞—Ä</h2>
                                    <div class="product-price-main" id="productPrice">–¶–µ–Ω–∞</div>

                                    <div class="product-desc-block" id="productDescBlock">
                                        <h4 class="product-section-title">–û–ø–∏—Å–∞–Ω–∏–µ</h4>
                                        <p class="product-desc" id="productDesc"></p>
                                    </div>

                                    <div class="product-specs" id="productSpecsBlock">
                                        <h4 class="product-section-title">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h4>
                                        <ul id="productSpecs"></ul>
                                    </div>

                                    <div class="product-actions">
                                        <button class="btn btn-outline-gold btn-outline-pill" type="button" data-close-product>
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:-2px;"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>–ù–∞–∑–∞–¥
                                        </button>
                                        <a class="btn btn-primary btn-primary-pill" href="https://t.me/Daniil_Dealer" target="_blank" rel="noopener" id="productBtnContact">–£–∑–Ω–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É</a>
                                    </div>

                                    <div class="product-id-line" id="productIdLine"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

<script>
// ============================================
// DISABLE ZOOM ON MOBILE
// ============================================
(function() {
    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ pinch-to-zoom
    document.addEventListener('touchstart', function(e) {
        if (e.touches.length > 1) {
            e.preventDefault();
        }
    }, { passive: false });

    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–≤–æ–π–Ω–æ–≥–æ —Ç–∞–ø–∞ –¥–ª—è –∑—É–º–∞
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(e) {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) {
            e.preventDefault();
        }
        lastTouchEnd = now;
    }, { passive: false });

    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∂–µ—Å—Ç–∞ –∑—É–º–∞
    document.addEventListener('gesturestart', function(e) {
        e.preventDefault();
    }, { passive: false });

    document.addEventListener('gesturechange', function(e) {
        e.preventDefault();
    }, { passive: false });

    document.addEventListener('gestureend', function(e) {
        e.preventDefault();
    }, { passive: false });
})();

// Mobile menu
(function() {
    const toggle = document.querySelector('[data-mobile-nav-toggle]');
    const nav = document.querySelector('[data-mobile-nav]');
    const close = document.querySelector('[data-mobile-nav-close]');
    const panel = document.querySelector('.header-mobile-panel');
    const header = document.querySelector('header');

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ–∑–∏—Ü–∏–∏ –º–µ–Ω—é —Ä–æ–≤–Ω–æ –æ—Ç –∑–æ–ª–æ—Ç–æ–π –ª–∏–Ω–∏–∏
    function updateMenuPosition() {
        if (header && panel) {
            const headerHeight = header.offsetHeight;
            panel.style.top = headerHeight + 'px';
        }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏ —Ä–µ—Å–∞–π–∑–µ
    updateMenuPosition();
    window.addEventListener('resize', updateMenuPosition);
    window.addEventListener('scroll', updateMenuPosition);
    
    function setMobileNav(open) {
        if (!nav) return;
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º
        updateMenuPosition();
        nav.classList.toggle('is-open', open);
        nav.setAttribute('aria-hidden', !open);
        if (toggle) {
            toggle.setAttribute('aria-expanded', open);
            // –î–æ–±–∞–≤–ª—è–µ–º/—É–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å is-active –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –±—É—Ä–≥–µ—Ä–∞ –≤ –∫—Ä–µ—Å—Ç–∏–∫
            toggle.classList.toggle('is-active', open);
        }
    }
    
    if (toggle && nav) {
        toggle.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = nav.classList.contains('is-open');
            setMobileNav(!isOpen);
        });
    }
    if (close && nav) {
        close.addEventListener('click', () => setMobileNav(false));
    }
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Å—Å—ã–ª–∫—É
    if (nav) {
        nav.addEventListener('click', (e) => {
            if (e.target.tagName === 'A') setMobileNav(false);
        });
    }
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–µ–Ω—é
    document.addEventListener('click', (e) => {
        if (nav && nav.classList.contains('is-open')) {
            const menuPanel = nav.querySelector('.header-mobile-panel');
            if (menuPanel && !menuPanel.contains(e.target) && e.target !== toggle && !toggle.contains(e.target)) {
                setMobileNav(false);
            }
        }
    });
})();

// Header scroll effect
window.addEventListener('scroll', () => {
    const header = document.querySelector('header');
    if (header) {
        header.classList.toggle('scrolled', window.scrollY > 50);
    }
});

// Catalog functionality
(function initCatalog(){
    const API = "/botCATALOG/catalog-api.php";
    const grid = document.querySelector('[data-catalog-grid]');
    const empty = document.querySelector('[data-catalog-empty]');
    const searchInput = document.querySelector('[data-catalog-search]');
    const catBtns = document.querySelectorAll('[data-catalog-cat]');
    const loadingEl = document.querySelector('[data-catalog-loading]');
    const loadMoreWrap = document.querySelector('[data-catalog-load-more]');
    const loadMoreBtn = document.querySelector('[data-load-more-btn]');
    const loadMoreCount = document.querySelector('[data-load-more-count]');
    
    if (!grid) return;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    if (loadingEl) loadingEl.hidden = false;

    const CAT_LABEL = {
        jewelry: '–Æ–≤–µ–ª–∏—Ä–Ω—ã–µ –∏–∑–¥–µ–ª–∏—è',
        bags: '–°—É–º–∫–∏',
        watches: '–ß–∞—Å—ã',
        accessories: '–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã'
    };

    let allItems = [];
    let filteredItems = [];
    let currentCat = 'all';
    let searchQuery = '';
    let visibleCount = 0;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞
    function getItemsPerPage() {
        return window.innerWidth <= 768 ? 6 : 8;
    }

    function esc(s) {
        return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function normalizeValue(v) {
        if (v === null || v === undefined) return '';
        if (typeof v === 'object') {
            // –ï—Å–ª–∏ —ç—Ç–æ –º–∞—Å—Å–∏–≤ ‚Äî —Å–æ–µ–¥–∏–Ω—è–µ–º —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
            if (Array.isArray(v)) return v.map(x => String(x).trim()).filter(Boolean).join(', ');
            // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç ‚Äî –ø—Ä–æ–±—É–µ–º JSON –∏–ª–∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            try { return JSON.stringify(v); } catch(e) { return ''; }
        }
        return String(v).trim();
    }

    // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è specs –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
    function extractSpecs(item) {
        if (!item) return '';
        
        // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–ª—è specs
        let rawSpecs = item.specs || item.specifications || item.characteristics || '';
        
        // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç ‚Äî –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å—Ç—Ä–æ–∫—É "–∫–ª—é—á: –∑–Ω–∞—á–µ–Ω–∏–µ"
        if (typeof rawSpecs === 'object' && rawSpecs !== null && !Array.isArray(rawSpecs)) {
            return Object.entries(rawSpecs)
                .filter(([k, v]) => v !== null && v !== undefined && v !== '')
                .map(([k, v]) => `${k}:${v}`)
                .join('|');
        }
        
        // –ï—Å–ª–∏ —ç—Ç–æ –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ [{key, value}]
        if (Array.isArray(rawSpecs)) {
            return rawSpecs
                .filter(spec => spec && (spec.key || spec.name || spec.label))
                .map(spec => {
                    const k = spec.key || spec.name || spec.label || '';
                    const v = spec.value || spec.val || '';
                    return `${k}:${v}`;
                })
                .join('|');
        }
        
        // –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
        if (typeof rawSpecs === 'string' && rawSpecs.trim()) {
            return rawSpecs;
        }
        
        return '';
    }

    function formatPrice(item) {
        if (item && (item.priceOnRequest || item.price_on_request)) return '–¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É';
        const raw = item?.price_rub ?? item?.price ?? item?.priceValue ?? '';
        const s = normalizeValue(raw);
        if (!s) return '–¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É';
        if (/–∑–∞–ø—Ä–æ—Å/i.test(s)) return '–¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É';
        const n = Number(String(s).replace(/\s+/g,'').replace(',', '.'));
        if (!Number.isFinite(n)) return s;
        try { return new Intl.NumberFormat('ru-RU').format(Math.round(n)) + ' ‚ÇΩ'; }
        catch(e){ return Math.round(n) + ' ‚ÇΩ'; }
    }

    function buildSpecs(item) {
        // –°–æ–±–∏—Ä–∞–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–∑ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π item
        const pairs = [];
        const addedKeys = new Set(); // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π
        
        const add = (k, v) => {
            if (v === null || v === undefined || v === '') return;
            const vv = typeof v === 'object' ? JSON.stringify(v) : String(v).trim();
            if (!vv || vv === '{}' || vv === '[]') return;
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –∫–ª—é—á
            const keyLower = k.toLowerCase();
            if (addedKeys.has(keyLower)) return;
            addedKeys.add(keyLower);
            pairs.push(`${k}:${vv}`);
        };
        
        // –í—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø–æ–ª—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
        // –ë—Ä–µ–Ω–¥ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω–∏—è (–ü–ï–†–í–´–ú!)
        add('–ë—Ä–µ–Ω–¥', item?.brand || item?.Brand || item?.['–ë—Ä–µ–Ω–¥'] || item?.['–±—Ä–µ–Ω–¥']);
        add('–ú–æ–¥–µ–ª—å', item?.model || item?.Model || item?.['–ú–æ–¥–µ–ª—å']);
        add('–†–µ—Ñ–µ—Ä–µ–Ω—Å', item?.ref || item?.reference || item?.Reference);
        add('–¢–∏–ø', item?.type || item?.Type || item?.['–¢–∏–ø']);
        add('–ú–µ—Ç–∞–ª–ª', item?.metal || item?.Metal || item?.['–ú–µ—Ç–∞–ª–ª']);
        add('–ü—Ä–æ–±–∞', item?.proba || item?.gold_type || item?.['–ü—Ä–æ–±–∞']);
        add('–ö–∞–º–µ–Ω—å', item?.stone || item?.Stone || item?.['–ö–∞–º–µ–Ω—å']);
        add('–í–µ—Å –∫–∞–º–Ω—è', item?.stone_weight || item?.carat || item?.carats);
        add('–¶–≤–µ—Ç –∫–∞–º–Ω—è', item?.stone_color);
        add('–ß–∏—Å—Ç–æ—Ç–∞', item?.clarity);
        add('–û–≥—Ä–∞–Ω–∫–∞', item?.cut);
        add('–§–æ—Ä–º–∞', item?.shape);
        add('–ú–∞—Ç–µ—Ä–∏–∞–ª', item?.material || item?.Material || item?.['–ú–∞—Ç–µ—Ä–∏–∞–ª']);
        add('–†–∞–∑–º–µ—Ä', item?.size || item?.Size || item?.['–†–∞–∑–º–µ—Ä']);
        add('–í–µ—Å –∏–∑–¥–µ–ª–∏—è', item?.weight || item?.total_weight);
        add('–î–ª–∏–Ω–∞', item?.length);
        add('–®–∏—Ä–∏–Ω–∞', item?.width);
        add('–ì–æ–¥', item?.year || item?.Year || item?.['–ì–æ–¥']);
        add('–°–æ—Å—Ç–æ—è–Ω–∏–µ', item?.condition || item?.Condition || item?.['–°–æ—Å—Ç–æ—è–Ω–∏–µ']);
        add('–ö–æ–º–ø–ª–µ–∫—Ç', item?.kit || item?.set || item?.package);
        add('–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç', item?.certificate || item?.cert);
        add('–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è', item?.lab);
        add('–°—Ç—Ä–∞–Ω–∞', item?.country || item?.Country || item?.['–°—Ç—Ä–∞–Ω–∞']);
        add('–ê—Ä—Ç–∏–∫—É–ª', item?.sku || item?.article);
        
        // –¢–µ–ø–µ—Ä—å –¥–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ extractSpecs (–µ—Å–ª–∏ –µ—Å—Ç—å)
        // –û–Ω–∏ –¥–æ–±–∞–≤—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–∞–∫–æ–≥–æ –∫–ª—é—á–∞ –µ—â—ë –Ω–µ—Ç
        const extracted = extractSpecs(item);
        if (extracted && !extracted.includes('[object')) {
            if (extracted.includes('|') || extracted.includes(':')) {
                extracted.split(/[\n;|]/).forEach(line => {
                    const trimmed = line.trim();
                    if (!trimmed || !trimmed.includes(':')) return;
                    const [k, ...rest] = trimmed.split(':');
                    const key = k.trim();
                    const val = rest.join(':').trim();
                    if (key && val) {
                        add(key, val);
                    }
                });
            }
        }
        
        return pairs.join('|');
    }

    function pickTitle(item) {
        return normalizeValue(item?.title || item?.name || '') || '–¢–æ–≤–∞—Ä';
    }

    function pickText(item) {
        return normalizeValue(item?.short || item?.subtitle || item?.summary || '');
    }

    function pickDesc(item) {
        return normalizeValue(item?.desc || item?.description || '');
    }

    function pickPhotos(item) {
        const arr = item?.photos || item?.images || [];
        if (Array.isArray(arr)) return arr.map(s => String(s||'').trim()).filter(Boolean).slice(0, 4);
        if (typeof arr === 'string') return arr.split(/[|,\n]/).map(s => s.trim()).filter(Boolean).slice(0, 4);
        return [];
    }

    function cardHtml(item) {
        const group = normalizeValue(item?.group || item?.cat || item?.category || '').toLowerCase();
        const cat = CAT_LABEL[group] ? group : 'all';
        const title = pickTitle(item);
        const text = pickText(item);
        const desc = pickDesc(item) || text;
        const price = formatPrice(item);
        const photos = pickPhotos(item);
        const cover = photos[0] || '';
        const specs = buildSpecs(item);
        const pid = normalizeValue(item?.id || item?.product_id || '') || (cat + '_' + Math.random().toString(16).slice(2));
        const categoryLabel = CAT_LABEL[group] || '–ö–∞—Ç–µ–≥–æ—Ä–∏—è';

        return `
            <article class="glass-card catalog-card"
                data-catalog-item
                data-cat="${esc(cat)}"
                data-category="${esc(categoryLabel)}"
                data-title="${esc(title)}"
                data-text="${esc(text)}"
                data-product-id="${esc(pid)}"
                data-price="${esc(price)}"
                data-desc="${esc(desc)}"
                data-specs="${esc(specs)}"
                data-images="${esc(photos.join('|'))}">
                <div class="catalog-card__img" data-card-carousel>
                    <div class="catalog-card__slides" data-slides>
                        ${photos.length > 0 
                            ? photos.map((photo, i) => `<img src="${esc(photo)}" alt="" loading="lazy" class="${i === 0 ? 'is-active' : ''}" data-slide="${i}" />`).join('')
                            : '<div class="catalog-card__no-img"></div>'
                        }
                    </div>
                    ${photos.length > 1 ? `
                        <div class="catalog-card__dots" data-dots>
                            ${photos.map((_, i) => `<span class="catalog-card__dot ${i === 0 ? 'is-active' : ''}" data-dot="${i}"></span>`).join('')}
                        </div>
                    ` : ''}
                </div>
                <div class="catalog-card__body">
                    <h3 class="catalog-card__title">${esc(title)}</h3>
                    <div class="catalog-card__meta">
                        <span class="catalog-price-label">–¶–µ–Ω–∞:</span>
                        <span class="catalog-price">${esc(price)}</span>
                    </div>
                    <span class="catalog-card__note">–£—Ç–æ—á–Ω—è–π—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É</span>
                    ${pid ? `<div class="catalog-card__id">ID: ${esc(pid)}</div>` : ''}
                </div>
            </article>
        `;
    }

    function filterAndRender() {
        // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
        if (loadingEl) loadingEl.hidden = true;
        
        filteredItems = allItems.slice();
        
        if (currentCat !== 'all') {
            filteredItems = filteredItems.filter(item => {
                const group = normalizeValue(item?.group || item?.cat || item?.category || '').toLowerCase();
                return group === currentCat;
            });
        }
        
        if (searchQuery) {
            const q = searchQuery.toLowerCase();
            filteredItems = filteredItems.filter(item => {
                const title = pickTitle(item).toLowerCase();
                const text = pickText(item).toLowerCase();
                const desc = pickDesc(item).toLowerCase();
                return title.includes(q) || text.includes(q) || desc.includes(q);
            });
        }

        if (!filteredItems.length) {
            grid.innerHTML = '';
            if (empty) empty.hidden = false;
            if (loadMoreWrap) loadMoreWrap.hidden = true;
            return;
        }

        if (empty) empty.hidden = true;
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –≤–∏–¥–∏–º—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
        visibleCount = Math.min(getItemsPerPage(), filteredItems.length);
        
        // –†–µ–Ω–¥–µ—Ä–∏–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏
        grid.innerHTML = filteredItems.map(cardHtml).join('');
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å
        updateVisibility();
        attachCardListeners();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–∞—Ä—Ç–æ—á–µ–∫
    function updateVisibility() {
        const cards = grid.querySelectorAll('[data-catalog-item]');
        
        cards.forEach((card, index) => {
            if (index < visibleCount) {
                card.classList.remove('is-hidden');
                card.classList.add('is-visible');
            } else {
                card.classList.add('is-hidden');
                card.classList.remove('is-visible');
            }
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë"
        updateLoadMoreButton();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–¥–≥—Ä—É–∑–∫–∏
    function updateLoadMoreButton() {
        if (!loadMoreWrap) return;
        
        const remaining = filteredItems.length - visibleCount;
        
        if (remaining > 0) {
            loadMoreWrap.hidden = false;
            const nextBatch = Math.min(getItemsPerPage(), remaining);
            if (loadMoreCount) {
                loadMoreCount.textContent = `+${nextBatch}`;
            }
        } else {
            loadMoreWrap.hidden = true;
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ—Ä—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤
    function loadMore() {
        const itemsPerPage = getItemsPerPage();
        const newVisibleCount = Math.min(visibleCount + itemsPerPage, filteredItems.length);
        
        // –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
        const cards = grid.querySelectorAll('[data-catalog-item]');
        
        for (let i = visibleCount; i < newVisibleCount; i++) {
            if (cards[i]) {
                cards[i].classList.remove('is-hidden');
                cards[i].classList.add('is-visible');
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –∫–∞—Å–∫–∞–¥–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
                cards[i].style.animationDelay = `${(i - visibleCount) * 0.05}s`;
            }
        }
        
        visibleCount = newVisibleCount;
        updateLoadMoreButton();
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë"
    if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', loadMore);
    }

    // –ü–µ—Ä–µ—Å—á—ë—Ç –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            // –ï—Å–ª–∏ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–æ –±–æ–ª—å—à–µ —Ç–æ–≤–∞—Ä–æ–≤ —á–µ–º –±–∞–∑–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ - –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
            const baseCount = getItemsPerPage();
            if (visibleCount < baseCount) {
                visibleCount = Math.min(baseCount, filteredItems.length);
                updateVisibility();
            }
            updateLoadMoreButton();
        }, 250);
    });

    function render(items) {
        allItems = Array.isArray(items) ? items : [];
        filterAndRender();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ product –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
        openProductFromUrl();
    }
    
    function openProductFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('product');
        if (productId) {
            // –ò—â–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Å –Ω—É–∂–Ω—ã–º ID
            const card = grid.querySelector(`[data-product-id="${productId}"]`);
            if (card) {
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
                setTimeout(() => openProduct(card), 100);
            }
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –≤ –±—Ä–∞—É–∑–µ—Ä–µ
    window.addEventListener('popstate', function(e) {
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('product');
        
        if (productId) {
            const card = grid.querySelector(`[data-product-id="${productId}"]`);
            if (card) openProduct(card);
        } else {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è URL
            productOverlay.classList.remove('active');
            productOverlay.setAttribute('aria-hidden', 'true');
            unlockPageScroll();
        }
    });

    window.renderCatalog = function(payload) {
        console.log('Catalog payload:', payload);
        if (payload && payload.items && payload.items[0]) {
            console.log('First item structure:', payload.items[0]);
            console.log('First item keys:', Object.keys(payload.items[0]));
        }
        if (!payload || payload.ok !== true) return;
        render(payload.items || []);
    };

    function load() {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        if (loadingEl) loadingEl.hidden = false;
        if (loadMoreWrap) loadMoreWrap.hidden = true;
        
        const url = API + '?callback=renderCatalog&_=' + Date.now();
        const script = document.createElement('script');
        script.src = url;
        script.onerror = () => { 
            if (loadingEl) loadingEl.hidden = true;
            if (empty) empty.hidden = false; 
        };
        document.head.appendChild(script);
    }

    // Category filter
    catBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            catBtns.forEach(b => {
                b.classList.remove('is-active');
                b.setAttribute('aria-selected', 'false');
            });
            btn.classList.add('is-active');
            btn.setAttribute('aria-selected', 'true');
            currentCat = btn.dataset.catalogCat;
            filterAndRender();
        });
    });

    // Search filter
    if (searchInput) {
        searchInput.addEventListener('input', () => {
            searchQuery = searchInput.value.trim();
            filterAndRender();
        });
    }

    // Product modal
    const productOverlay = document.getElementById('page-product');
    const productMainImage = document.getElementById('productMainImage');
    const productThumbs = document.getElementById('productThumbs');
    const productTitle = document.getElementById('productTitle');
    const productTitleBar = document.getElementById('productTitleBar');
    const productCategory = document.getElementById('productCategory');
    const productPrice = document.getElementById('productPrice');
    const productDesc = document.getElementById('productDesc');
    const productDescBlock = document.getElementById('productDescBlock');
    const productSpecs = document.getElementById('productSpecs');
    const productSpecsBlock = document.getElementById('productSpecsBlock');
    const productIdLine = document.getElementById('productIdLine');
    const btnPrev = document.querySelector('[data-carousel-prev]');
    const btnNext = document.querySelector('[data-carousel-next]');
    const btnClose = document.querySelectorAll('[data-close-product]');
    const productCloseBtn = document.getElementById('productCloseBtn');

    let images = [];
    let index = 0;
// Scroll lock (iOS-safe)
    let __lockedScrollY = 0;
    function lockPageScroll(){
        __lockedScrollY = window.scrollY || window.pageYOffset || 0;
        document.documentElement.classList.add('overlay-open');
        document.body.style.top = `-${__lockedScrollY}px`;
    }
    function unlockPageScroll(){
        document.documentElement.classList.remove('overlay-open');
        const y = __lockedScrollY || 0;
        document.body.style.top = '';
        window.scrollTo(0, y);
    }


    function openProduct(card) {
        const title = card.dataset.title || '–¢–æ–≤–∞—Ä';
        const price = card.dataset.price || '–¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É';
        const cat = card.querySelector('.catalog-pill')?.textContent || card.dataset.category || '–ö–∞—Ç–µ–≥–æ—Ä–∏—è';
        const desc = card.dataset.desc || '';
        const specs = card.dataset.specs || '';
        const pid = card.dataset.productId || '';
        const imgs = (card.dataset.images || '').split('|').filter(Boolean);

        productTitle.textContent = title;
        if (productTitleBar) productTitleBar.textContent = title;
        if (productCategory) productCategory.textContent = cat;
        productPrice.textContent = price;

        if (desc) {
            productDesc.textContent = desc;
            productDescBlock.style.display = '';
        } else {
            productDescBlock.style.display = 'none';
        }

        if (specs) {
            productSpecs.innerHTML = specs.split('|').map(pair => {
                const [k, v] = pair.split(':');
                return `<li><span class="k">${esc(k)}</span><span class="v">${esc(v)}</span></li>`;
            }).join('');
            productSpecsBlock.style.display = '';
        } else {
            productSpecsBlock.style.display = 'none';
        }

        if (pid) {
            productIdLine.textContent = 'ID —Ç–æ–≤–∞—Ä–∞: ' + pid;
            productIdLine.style.display = '';
        } else {
            productIdLine.style.display = 'none';
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º product
        if (pid) {
            const newUrl = window.location.pathname + '?product=' + encodeURIComponent(pid);
            history.pushState({ product: pid }, '', newUrl);
        }

        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–æ–≤–∞—Ä –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è Telegram
        const productBtnContact = document.getElementById('productBtnContact');
        if (productBtnContact) {
            const productUrl = window.location.origin + window.location.pathname + '?product=' + encodeURIComponent(pid);
            const message = `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –•–æ—á—É —É–∑–Ω–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –Ω–∞:\n\nüì¶ ${title}\nüÜî ID: ${pid}\nüîó ${productUrl}`;
            const tgUrl = 'https://t.me/Daniil_Dealer?text=' + encodeURIComponent(message);
            productBtnContact.href = tgUrl;
        }

        images = imgs.length ? imgs : [''];
        index = 0;
        renderThumbs();
        setImage(0);

        productOverlay.classList.add('active');
        productOverlay.setAttribute('aria-hidden', 'false');
        lockPageScroll();
    }

    function closeProduct() {
        productOverlay.classList.remove('active');
        productOverlay.setAttribute('aria-hidden', 'true');
        unlockPageScroll();
        
        // –£–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä product –∏–∑ URL
        history.pushState({}, '', window.location.pathname);
    }

    function renderThumbs() {
        productThumbs.innerHTML = images.map((src, i) => 
            `<button type="button" class="product-thumb ${i === 0 ? 'is-active' : ''}" data-thumb="${i}">
                <img src="${esc(src)}" alt="" loading="lazy">
            </button>`
        ).join('');

        productThumbs.querySelectorAll('[data-thumb]').forEach(btn => {
            btn.addEventListener('click', () => setImage(parseInt(btn.dataset.thumb)));
        });
    }

    function setImage(i) {
        if (i < 0) i = images.length - 1;
        if (i >= images.length) i = 0;
        index = i;
        productMainImage.src = images[index] || '';
        productThumbs.querySelectorAll('.product-thumb').forEach((t, idx) => {
            t.classList.toggle('is-active', idx === index);
        });
    }

    function attachCardListeners() {
        grid.querySelectorAll('[data-catalog-item]').forEach(card => {
            const carousel = card.querySelector('[data-card-carousel]');
            const slides = card.querySelectorAll('[data-slide]');
            const dots = card.querySelectorAll('[data-dot]');
            
            if (slides.length > 1 && carousel) {
                let currentSlide = 0;
                let startX = 0;
                let startY = 0;
                let isDragging = false;
                
                function goToSlide(index) {
                    if (index < 0) index = slides.length - 1;
                    if (index >= slides.length) index = 0;
                    currentSlide = index;
                    
                    slides.forEach((s, i) => s.classList.toggle('is-active', i === index));
                    dots.forEach((d, i) => d.classList.toggle('is-active', i === index));
                }
                
                // Touch events –¥–ª—è —Å–≤–∞–π–ø–∞
                carousel.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    isDragging = true;
                }, { passive: true });
                
                carousel.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    const dx = e.touches[0].clientX - startX;
                    const dy = e.touches[0].clientY - startY;
                    
                    // –ï—Å–ª–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª
                    if (Math.abs(dx) > 10 && Math.abs(dx) > Math.abs(dy)) {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                carousel.addEventListener('touchend', (e) => {
                    if (!isDragging) return;
                    isDragging = false;
                    
                    const dx = e.changedTouches[0].clientX - startX;
                    const dy = e.changedTouches[0].clientY - startY;
                    
                    // –°–≤–∞–π–ø –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª–∏–Ω–Ω—ã–º –∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–º
                    if (Math.abs(dx) > 40 && Math.abs(dx) > Math.abs(dy)) {
                        if (dx < 0) {
                            goToSlide(currentSlide + 1);
                        } else {
                            goToSlide(currentSlide - 1);
                        }
                        e.preventDefault();
                        e.stopPropagation();
                        return;
                    }
                }, { passive: false });
                
                // –ö–ª–∏–∫ –ø–æ —Ç–æ—á–∫–∞–º
                dots.forEach((dot, i) => {
                    dot.addEventListener('click', (e) => {
                        e.stopPropagation();
                        goToSlide(i);
                    });
                });
            }
            
            // –ö–ª–∏–∫ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
            card.addEventListener('click', (e) => {
                if (e.target.closest('a, button, [data-dot]')) return;
                openProduct(card);
            });
        });
    }

    if (btnPrev) btnPrev.addEventListener('click', () => setImage(index - 1));
    if (btnNext) btnNext.addEventListener('click', () => setImage(index + 1));
    btnClose.forEach(el => el.addEventListener('click', closeProduct));
    if (productCloseBtn) productCloseBtn.addEventListener('click', closeProduct);
// Swipe on main image (left/right)
    (function(){
        const mainArea = document.querySelector('#page-product .product-carousel__main');
        if (!mainArea) return;

        let startX = 0, startY = 0, dragging = false;

        function onStart(e){
            const t = e.touches ? e.touches[0] : e;
            startX = t.clientX;
            startY = t.clientY;
            dragging = true;
        }

        function onMove(e){
            if (!dragging) return;
            const t = e.touches ? e.touches[0] : e;
            const dx = t.clientX - startX;
            const dy = t.clientY - startY;

            // If horizontal intent ‚Äî prevent vertical scroll jitter
            if (Math.abs(dx) > 10 && Math.abs(dx) > Math.abs(dy)){
                e.preventDefault();
            }
        }

        function onEnd(e){
            if (!dragging) return;
            dragging = false;
            const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : e;
            const dx = t.clientX - startX;
            const dy = t.clientY - startY;

            if (Math.abs(dx) < 40 || Math.abs(dx) < Math.abs(dy)) return;

            if (dx < 0) setImage(index + 1);  // swipe left -> next
            else setImage(index - 1);         // swipe right -> prev
        }

        mainArea.addEventListener('touchstart', onStart, {passive:true});
        mainArea.addEventListener('touchmove', onMove, {passive:false});
        mainArea.addEventListener('touchend', onEnd, {passive:true});
        mainArea.addEventListener('touchcancel', () => { dragging = false; }, {passive:true});
    })();


    // Load catalog
    load();
})();

// ============================================
// PHOTO LIGHTBOX (Mobile only)
// ============================================
(function(){
    // –°–æ–∑–¥–∞—ë–º lightbox —ç–ª–µ–º–µ–Ω—Ç—ã
    const lightbox = document.createElement('div');
    lightbox.id = 'photo-lightbox';
    lightbox.className = 'photo-lightbox';
    lightbox.setAttribute('aria-hidden', 'true');
    lightbox.innerHTML = `
        <div class="photo-lightbox__backdrop"></div>
        <button class="photo-lightbox__close" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
            <span aria-hidden="true">√ó</span>
        </button>
        <div class="photo-lightbox__counter"></div>
        <div class="photo-lightbox__container">
            <img class="photo-lightbox__img" src="" alt="">
        </div>
        <button class="photo-lightbox__nav photo-lightbox__nav--prev" type="button" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Ñ–æ—Ç–æ">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 5.5a1 1 0 0 1 0 1.4L10.4 12l5.1 5.1a1 1 0 1 1-1.4 1.4l-5.8-5.8a1 1 0 0 1 0-1.4l5.8-5.8a1 1 0 0 1 1.4 0Z"/></svg>
        </button>
        <button class="photo-lightbox__nav photo-lightbox__nav--next" type="button" aria-label="–°–ª–µ–¥—É—é—â–µ–µ —Ñ–æ—Ç–æ">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8.5 18.5a1 1 0 0 1 0-1.4l5.1-5.1-5.1-5.1a1 1 0 1 1 1.4-1.4l5.8 5.8a1 1 0 0 1 0 1.4l-5.8 5.8a1 1 0 0 1-1.4 0Z"/></svg>
        </button>
    `;
    document.body.appendChild(lightbox);

    const backdrop = lightbox.querySelector('.photo-lightbox__backdrop');
    const closeBtn = lightbox.querySelector('.photo-lightbox__close');
    const container = lightbox.querySelector('.photo-lightbox__container');
    const img = lightbox.querySelector('.photo-lightbox__img');
    const counter = lightbox.querySelector('.photo-lightbox__counter');
    const prevBtn = lightbox.querySelector('.photo-lightbox__nav--prev');
    const nextBtn = lightbox.querySelector('.photo-lightbox__nav--next');

    let lightboxImages = [];
    let lightboxIndex = 0;
    let scale = 1;
    let posX = 0;
    let posY = 0;
    let startX = 0;
    let startY = 0;
    let startDist = 0;
    let startScale = 1;
    let isPinching = false;
    let isDragging = false;

    function isMobile() {
        return window.innerWidth <= 768 || 'ontouchstart' in window;
    }

    function openLightbox(images, index) {
        lightboxImages = images;
        lightboxIndex = index;
        resetTransform();
        updateLightboxImage();
        
        lightbox.classList.add('is-active');
        lightbox.setAttribute('aria-hidden', 'false');
        document.documentElement.classList.add('lightbox-open');
    }

    function closeLightbox() {
        lightbox.classList.remove('is-active');
        lightbox.setAttribute('aria-hidden', 'true');
        document.documentElement.classList.remove('lightbox-open');
        resetTransform();
    }

    function updateLightboxImage() {
        if (lightboxImages.length === 0) return;
        img.src = lightboxImages[lightboxIndex] || '';
        counter.textContent = `${lightboxIndex + 1} / ${lightboxImages.length}`;
        
        prevBtn.style.display = lightboxImages.length > 1 ? '' : 'none';
        nextBtn.style.display = lightboxImages.length > 1 ? '' : 'none';
    }

    function goToImage(newIndex) {
        if (newIndex < 0) newIndex = lightboxImages.length - 1;
        if (newIndex >= lightboxImages.length) newIndex = 0;
        lightboxIndex = newIndex;
        resetTransform();
        updateLightboxImage();
    }

    function resetTransform() {
        scale = 1;
        posX = 0;
        posY = 0;
        applyTransform();
    }

    function applyTransform() {
        img.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
    }

    function getDistance(touches) {
        const dx = touches[0].clientX - touches[1].clientX;
        const dy = touches[0].clientY - touches[1].clientY;
        return Math.sqrt(dx * dx + dy * dy);
    }

    // Touch events –¥–ª—è pinch-to-zoom –∏ pan
    container.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
            isPinching = true;
            isDragging = false;
            startDist = getDistance(e.touches);
            startScale = scale;
            e.preventDefault();
        } else if (e.touches.length === 1) {
            isDragging = true;
            isPinching = false;
            startX = e.touches[0].clientX - posX;
            startY = e.touches[0].clientY - posY;
        }
    }, { passive: false });

    container.addEventListener('touchmove', (e) => {
        if (isPinching && e.touches.length === 2) {
            e.preventDefault();
            const dist = getDistance(e.touches);
            const newScale = Math.min(Math.max(startScale * (dist / startDist), 1), 4);
            scale = newScale;
            applyTransform();
        } else if (isDragging && e.touches.length === 1 && scale > 1) {
            e.preventDefault();
            posX = e.touches[0].clientX - startX;
            posY = e.touches[0].clientY - startY;
            
            const maxX = (img.offsetWidth * scale - container.offsetWidth) / 2;
            const maxY = (img.offsetHeight * scale - container.offsetHeight) / 2;
            posX = Math.min(Math.max(posX, -maxX), maxX);
            posY = Math.min(Math.max(posY, -maxY), maxY);
            
            applyTransform();
        }
    }, { passive: false });

    container.addEventListener('touchend', (e) => {
        if (e.touches.length === 0) {
            isPinching = false;
            isDragging = false;
            
            if (scale < 1) {
                resetTransform();
            }
        } else if (e.touches.length === 1) {
            isPinching = false;
            isDragging = true;
            startX = e.touches[0].clientX - posX;
            startY = e.touches[0].clientY - posY;
        }
    });

    // –°–≤–∞–π–ø –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ñ–æ—Ç–æ
    let swipeStartX = 0;
    let swipeStartY = 0;
    
    container.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1 && scale === 1) {
            swipeStartX = e.touches[0].clientX;
            swipeStartY = e.touches[0].clientY;
        }
    }, { passive: true });

    container.addEventListener('touchend', (e) => {
        if (scale === 1 && e.changedTouches.length === 1) {
            const dx = e.changedTouches[0].clientX - swipeStartX;
            const dy = e.changedTouches[0].clientY - swipeStartY;
            
            if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy)) {
                if (dx < 0) {
                    goToImage(lightboxIndex + 1);
                } else {
                    goToImage(lightboxIndex - 1);
                }
            }
        }
    }, { passive: true });

    // –î–≤–æ–π–Ω–æ–π —Ç–∞–ø –¥–ª—è –∑—É–º–∞
    let lastTap = 0;
    container.addEventListener('touchend', (e) => {
        const now = Date.now();
        if (now - lastTap < 300 && e.changedTouches.length === 1) {
            e.preventDefault();
            if (scale > 1) {
                resetTransform();
            } else {
                scale = 2.5;
                applyTransform();
            }
        }
        lastTap = now;
    }, { passive: false });

    // Desktop: –∑—É–º –∫–æ–ª—ë—Å–∏–∫–æ–º –º—ã—à–∏
    container.addEventListener('wheel', (e) => {
        if (!lightbox.classList.contains('is-active')) return;
        e.preventDefault();
        
        const delta = e.deltaY > 0 ? -0.15 : 0.15;
        const newScale = Math.min(Math.max(scale + delta, 1), 4);
        
        if (newScale === 1) {
            resetTransform();
        } else {
            scale = newScale;
            applyTransform();
        }
    }, { passive: false });

    // Desktop: –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –º—ã—à—å—é –ø—Ä–∏ –∑—É–º–µ
    let isMouseDragging = false;
    let mouseStartX = 0;
    let mouseStartY = 0;

    container.addEventListener('mousedown', (e) => {
        if (scale > 1) {
            isMouseDragging = true;
            mouseStartX = e.clientX - posX;
            mouseStartY = e.clientY - posY;
            container.style.cursor = 'grabbing';
            e.preventDefault();
        }
    });

    document.addEventListener('mousemove', (e) => {
        if (!isMouseDragging || scale <= 1) return;
        
        posX = e.clientX - mouseStartX;
        posY = e.clientY - mouseStartY;
        
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
        const maxX = (img.offsetWidth * scale - container.offsetWidth) / 2;
        const maxY = (img.offsetHeight * scale - container.offsetHeight) / 2;
        posX = Math.min(Math.max(posX, -Math.max(0, maxX)), Math.max(0, maxX));
        posY = Math.min(Math.max(posY, -Math.max(0, maxY)), Math.max(0, maxY));
        
        applyTransform();
    });

    document.addEventListener('mouseup', () => {
        if (isMouseDragging) {
            isMouseDragging = false;
            container.style.cursor = scale > 1 ? 'grab' : '';
        }
    });

    // Desktop: –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è –∑—É–º–∞
    container.addEventListener('dblclick', (e) => {
        e.preventDefault();
        if (scale > 1) {
            resetTransform();
            container.style.cursor = '';
        } else {
            scale = 2.5;
            applyTransform();
            container.style.cursor = 'grab';
        }
    });

    // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    closeBtn.addEventListener('click', closeLightbox);
    backdrop.addEventListener('click', closeLightbox);
    prevBtn.addEventListener('click', () => goToImage(lightboxIndex - 1));
    nextBtn.addEventListener('click', () => goToImage(lightboxIndex + 1));

    document.addEventListener('keydown', (e) => {
        if (!lightbox.classList.contains('is-active')) return;
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowLeft') goToImage(lightboxIndex - 1);
        if (e.key === 'ArrowRight') goToImage(lightboxIndex + 1);
    });

    window.openPhotoLightbox = openLightbox;

    // –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫ –∫–∞—Ä—É—Å–µ–ª–∏ –≤ product overlay (—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –Ω–∞ mobile –∏ –Ω–∞ desktop)
    const productMainImage = document.getElementById('productMainImage');
    if (productMainImage) {
        productMainImage.addEventListener('click', () => {
            const thumbs = document.querySelectorAll('#productThumbs .product-thumb img');
            const images = Array.from(thumbs).map(t => t.src);
            const currentIndex = Array.from(document.querySelectorAll('#productThumbs .product-thumb')).findIndex(t => t.classList.contains('is-active'));
            
            if (images.length > 0) {
                openLightbox(images, currentIndex >= 0 ? currentIndex : 0);
            } else if (productMainImage.src) {
                openLightbox([productMainImage.src], 0);
            }
        });
        
        productMainImage.style.cursor = 'zoom-in';
    }
})();
</script>

</body>
</html>
