<?php
require __DIR__ . '/config.php';

header('Content-Type: application/json; charset=utf-8');

// –¢–æ–ª—å–∫–æ POST
if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    http_response_code(405);
    echo json_encode(['ok' => false, 'error' => '–†–∞–∑—Ä–µ—à—ë–Ω —Ç–æ–ª—å–∫–æ POST-–∑–∞–ø—Ä–æ—Å'], JSON_UNESCAPED_UNICODE);
    exit;
}

// Honeypot ‚Äî –∞–Ω—Ç–∏—Å–ø–∞–º
if (!empty($_POST['website'] ?? '')) {
    echo json_encode(['ok' => true], JSON_UNESCAPED_UNICODE);
    exit;
}

/**
 * –ú–ê–ü–ü–ò–ù–ì–ò: value –∏–∑ <option> -> —Ä—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç (–∫–∞–∫ –≤ —Å–ø–∏—Å–∫–∞—Ö –Ω–∞ —Å–∞–π—Ç–µ)
 */

// –ß—Ç–æ –∏—â–µ—Ç–µ
$requestMap = [
    // –ù–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    'bags'           => '–°—É–º–∫–∏',
    'watches'        => '–ß–∞—Å—ã',
    'accessories'    => '–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã',
    
    // –Æ–≤–µ–ª–∏—Ä–Ω—ã–µ –∏–∑–¥–µ–ª–∏—è
    'ring'           => '–ö–æ–ª—å—Ü–æ',
    'earrings'       => '–°–µ—Ä—å–≥–∏',
    'pendant'        => '–ö—É–ª–æ–Ω',
    'bracelet'       => '–ë—Ä–∞—Å–ª–µ—Ç',
    'necklace'       => '–ö–æ–ª—å–µ',
    'diamonds'       => '–ö–∞–º–Ω–∏ (–±—Ä–∏–ª–ª–∏–∞–Ω—Ç—ã)',
    'colored_stones' => '–ö–∞–º–Ω–∏ (—Ü–≤–µ—Ç–Ω—ã–µ)',
    'branded'        => '–ë—Ä–µ–Ω–¥–æ–≤—ã–µ –∏–∑–¥–µ–ª–∏—è',
    'brand_items'    => '–ë—Ä–µ–Ω–¥–æ–≤—ã–µ –∏–∑–¥–µ–ª–∏—è',
    'other'          => '–î—Ä—É–≥–æ–µ',

    // –µ—Å–ª–∏ –≤–¥—Ä—É–≥ —É–∂–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø–æ-—Ä—É—Å—Å–∫–∏
    '–°—É–º–∫–∏'               => '–°—É–º–∫–∏',
    '–ß–∞—Å—ã'                => '–ß–∞—Å—ã',
    '–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã'          => '–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã',
    '–ö–æ–ª—å—Ü–æ'              => '–ö–æ–ª—å—Ü–æ',
    '–°–µ—Ä—å–≥–∏'              => '–°–µ—Ä—å–≥–∏',
    '–ö—É–ª–æ–Ω'               => '–ö—É–ª–æ–Ω',
    '–ë—Ä–∞—Å–ª–µ—Ç'             => '–ë—Ä–∞—Å–ª–µ—Ç',
    '–ö–æ–ª—å–µ'               => '–ö–æ–ª—å–µ',
    '–ö–∞–º–Ω–∏ (–±—Ä–∏–ª–ª–∏–∞–Ω—Ç—ã)'  => '–ö–∞–º–Ω–∏ (–±—Ä–∏–ª–ª–∏–∞–Ω—Ç—ã)',
    '–ö–∞–º–Ω–∏ (—Ü–≤–µ—Ç–Ω—ã–µ)'     => '–ö–∞–º–Ω–∏ (—Ü–≤–µ—Ç–Ω—ã–µ)',
    '–ë—Ä–µ–Ω–¥–æ–≤—ã–µ –∏–∑–¥–µ–ª–∏—è'   => '–ë—Ä–µ–Ω–¥–æ–≤—ã–µ –∏–∑–¥–µ–ª–∏—è',
    '–î—Ä—É–≥–æ–µ'              => '–î—Ä—É–≥–æ–µ',
];

// –ë—é–¥–∂–µ—Ç ‚Äî –í–ê–ñ–ù–û: –∫–ª—é—á–∏ 1:1 –∫–∞–∫ value –≤ —Ç–≤–æ—ë–º HTML
$budgetMap = [
    // —Ç–≤–æ–∏ —Ä–µ–∞–ª—å–Ω—ã–µ value –∏–∑ —Ñ–æ—Ä–º—ã
    'to_70k'      => '–î–æ 70 000 ‚ÇΩ',
    'up_to_100k'  => '–î–æ 100 000 ‚ÇΩ',
    '100k_300k'   => '100 000 ‚Äì 300 000 ‚ÇΩ',
    '300k_500k'   => '300 000 ‚Äì 500 000 ‚ÇΩ',
    '500k_1m'     => '500 000 ‚Äì 1 000 000 ‚ÇΩ',
    'over_1m'     => '–û—Ç 1 000 000 ‚ÇΩ',

    // –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã (–Ω–∞ –≤—Å—è–∫–∏–π)
    '100_300k'       => '100 000 ‚Äì 300 000 ‚ÇΩ',
    '300_500k'       => '300 000 ‚Äì 500 000 ‚ÇΩ',
    '500_1000k'      => '500 000 ‚Äì 1 000 000 ‚ÇΩ',
    'from_1000k'     => '–û—Ç 1 000 000 ‚ÇΩ',
    'from_1000000'   => '–û—Ç 1 000 000 ‚ÇΩ',
    '1000000_plus'   => '–û—Ç 1 000 000 ‚ÇΩ',
    '1000000+'       => '–û—Ç 1 000 000 ‚ÇΩ',

    // –µ—Å–ª–∏ —É–∂–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø–æ-—Ä—É—Å—Å–∫–∏
    '–î–æ 70 000 ‚ÇΩ'            => '–î–æ 70 000 ‚ÇΩ',
    '–î–æ 100 000 ‚ÇΩ'           => '–î–æ 100 000 ‚ÇΩ',
    '100 000 ‚Äì 300 000 ‚ÇΩ'    => '100 000 ‚Äì 300 000 ‚ÇΩ',
    '300 000 ‚Äì 500 000 ‚ÇΩ'    => '300 000 ‚Äì 500 000 ‚ÇΩ',
    '500 000 ‚Äì 1 000 000 ‚ÇΩ'  => '500 000 ‚Äì 1 000 000 ‚ÇΩ',
    '–û—Ç 1 000 000 ‚ÇΩ'         => '–û—Ç 1 000 000 ‚ÇΩ',
];

// –°—Ä–æ–∫–∏
$deadlineMap = [
    'urgent'     => '–°—Ä–æ—á–Ω–æ (–¥–æ 7 –¥–Ω–µ–π)',
    'urgent_7'   => '–°—Ä–æ—á–Ω–æ (–¥–æ 7 –¥–Ω–µ–π)',
    '2_3_weeks'  => '2‚Äì3 –Ω–µ–¥–µ–ª–∏',
    'month'      => '–ú–µ—Å—è—Ü',
    'not_urgent' => '–ù–µ —Å—Ä–æ—á–Ω–æ',

    // –µ—Å–ª–∏ —É–∂–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø–æ-—Ä—É—Å—Å–∫–∏
    '–°—Ä–æ—á–Ω–æ (–¥–æ 7 –¥–Ω–µ–π)' => '–°—Ä–æ—á–Ω–æ (–¥–æ 7 –¥–Ω–µ–π)',
    '–°—Ä–æ—á–Ω–æ (–¥–æ7 –¥–Ω–µ–π)'  => '–°—Ä–æ—á–Ω–æ (–¥–æ 7 –¥–Ω–µ–π)',
    '2-3 –Ω–µ–¥–µ–ª–∏'         => '2‚Äì3 –Ω–µ–¥–µ–ª–∏',
    '2‚Äì3 –Ω–µ–¥–µ–ª–∏'         => '2‚Äì3 –Ω–µ–¥–µ–ª–∏',
    '–ú–µ—Å—è—Ü'              => '–ú–µ—Å—è—Ü',
    '–ù–µ —Å—Ä–æ—á–Ω–æ'          => '–ù–µ —Å—Ä–æ—á–Ω–æ',
];

// –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –±—é–¥–∂–µ—Ç–∞: —Å–Ω–∞—á–∞–ª–∞ –º–∞–ø–ø–∏–Ω–≥, –ø–æ—Ç–æ–º fallback (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ –ø—Ä–∏–ª–µ—Ç–∏—Ç –∏–Ω–æ–π —Ñ–æ—Ä–º–∞—Ç)
function normalize_budget_to_list($raw, $budgetMap) {
    $raw = trim((string)$raw);

    // –≥–ª–∞–≤–Ω–æ–µ: —Ç–æ—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ value
    if (isset($budgetMap[$raw])) {
        return $budgetMap[$raw];
    }

    // fallback: –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –∫–æ–≥–¥–∞-—Ç–æ –ø—Ä–∏–¥—ë—Ç "500000_1000000" –∏–ª–∏ "500 000 - 1 000 000"
    preg_match_all('/\d+/', $raw, $m);
    $nums = array_map('intval', $m[0] ?? []);

    if (count($nums) === 1) {
        $n = $nums[0];
        if ($n <= 70000) return '–î–æ 70 000 ‚ÇΩ';
        if ($n <= 100000) return '–î–æ 100 000 ‚ÇΩ';
        if ($n <= 300000) return '100 000 ‚Äì 300 000 ‚ÇΩ';
        if ($n <= 500000) return '300 000 ‚Äì 500 000 ‚ÇΩ';
        if ($n <= 1000000) return '500 000 ‚Äì 1 000 000 ‚ÇΩ';
        return '–û—Ç 1 000 000 ‚ÇΩ';
    }

    if (count($nums) >= 2) {
        $a = $nums[0];
        $b = $nums[1];
        if ($a > $b) { $t = $a; $a = $b; $b = $t; }

        if ($a >= 1000000 || $b > 1000000) return '–û—Ç 1 000 000 ‚ÇΩ';

        if ($b <= 70000) return '–î–æ 70 000 ‚ÇΩ';
        if ($b <= 100000) return '–î–æ 100 000 ‚ÇΩ';
        if ($a >= 100000 && $b <= 300000) return '100 000 ‚Äì 300 000 ‚ÇΩ';
        if ($a >= 300000 && $b <= 500000) return '300 000 ‚Äì 500 000 ‚ÇΩ';
        if ($a >= 500000 && $b <= 1000000) return '500 000 ‚Äì 1 000 000 ‚ÇΩ';
    }

    return $raw;
}

// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
$name    = trim($_POST['name'] ?? '');
$contact = trim($_POST['contact'] ?? '');
$consent = !empty($_POST['consent'] ?? '');

// Raw –∑–Ω–∞—á–µ–Ω–∏—è —Å–µ–ª–µ–∫—Ç–æ–≤
$requestRaw  = trim($_POST['request'] ?? '');
$budgetRaw   = trim($_POST['budget'] ?? '');
$deadlineRaw = trim($_POST['deadline'] ?? '');

// –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ "–∫–∞–∫ –≤ —Å–ø–∏—Å–∫–µ"
$request  = $requestMap[$requestRaw] ?? $requestRaw;
$budget   = normalize_budget_to_list($budgetRaw, $budgetMap);
$deadline = $deadlineMap[$deadlineRaw] ?? $deadlineRaw;

// –í–∞–ª–∏–¥–∞—Ü–∏—è
if ($name === '' || $contact === '' || $request === '' || $budget === '' || $deadline === '' || !$consent) {
    http_response_code(400);
    echo json_encode(['ok' => false, 'error' => '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è'], JSON_UNESCAPED_UNICODE);
    exit;
}

// –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
$message =
"üü° –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ —Å —Å–∞–π—Ç–∞ daniil-dealer.ru\n\n" .
"üë§ –ò–º—è: {$name}\n" .
"üìû –ö–æ–Ω—Ç–∞–∫—Ç: {$contact}\n" .
"üíé –ß—Ç–æ –∏—â–µ—Ç: {$request}\n" .
"üí∞ –ë—é–¥–∂–µ—Ç: {$budget}\n" .
"‚è± –°—Ä–æ–∫–∏: {$deadline}\n";

// –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
$url = "https://api.telegram.org/bot" . BOT_TOKEN . "/sendMessage";

$ch = curl_init($url);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_POST, true);
curl_setopt($ch, CURLOPT_POSTFIELDS, [
    'chat_id' => CHAT_ID,
    'text' => $message,
    'disable_web_page_preview' => true
]);

$response = curl_exec($ch);
$error    = curl_error($ch);
$httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
curl_close($ch);

$respJson = json_decode($response ?? '', true);

if ($error || $httpCode < 200 || $httpCode >= 300 || empty($respJson['ok'])) {
    http_response_code(500);
    echo json_encode(['ok' => false, 'error' => '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram'], JSON_UNESCAPED_UNICODE);
    exit;
}

echo json_encode(['ok' => true], JSON_UNESCAPED_UNICODE);